<?php
session_start();
$error = "";
$missing = "";
    if (array_key_exists("Logout", $_GET)) {
        unset($_SESSION);
        setcookie("id", "", time() - 60*60);
        $_COOKIE["id"] = "";  
        
    
    }else if ((array_key_exists("id", $_SESSION) AND $_SESSION['id']) OR (array_key_exists("id", $_COOKIE) AND $_COOKIE['id'])) {
        header("Location: loggedInPage.php");
    }
    if (array_key_exists("submit", $_POST))  {
    
    $link = mysqli_connect("127.0.0.1", "root", "", "etudiants");
    if(mysqli_connect_error()) {
        die("database error");
    }
    
    if(!$_POST['email']) {
        $missing.= "Email absent <br>";
    } 
    
    if($_POST['email'] && filter_var($_POST['email'] , FILTER_VALIDATE_EMAIL) === false) {
        $error.= "Votre email n'est pas valide<br>";
    }
    
    if(!$_POST['password']) {
        $missing.= "Mot de passe absent<br>";
    } 
    if($missing != "") {
        $error .= "Les espaces suivants doivent etre remplis: <br>" .$missing;
    }
    if($error != "") {
      
        $error = '<div class="alert alert-danger" role="alert"><p>Il y a des erreurs dans votre formulaire</p>' . $error . '</div>';
        
    } else {
        $query = "SELECT id FROM `class` WHERE email = '".mysqli_real_escape_string($link, $_POST['email'])."' LIMIT 1";
        $result = mysqli_query($link, $query);
        if (mysqli_num_rows($result) > 0) {
            $query = "SELECT id FROM `class` WHERE `password` = '".mysqli_real_escape_string($link, $_POST["password"])."' LIMIT 1";
            $result = mysqli_query($link, $query);
            $row =  mysqli_fetch_array($result);
            if(isset ($row) ) {
               $_SESSION['id'] = $row['id'];
               setcookie("id", $row['id'], time() + (86400 * 7), "/");
               header("Location: loggedInPage.php");
               
            }
             
    
        }else {
            
        $error = '<div class="alert alert-danger" role="alert"><p>Ce compte n existe pas dans notre base</p>' . $error . '</div>';
               
        }
        
    }
   }
?>